<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VPN –¥–ª—è Instagram –∏ YouTube</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 15px;
        }

        .card {
            max-width: 400px;
            margin: 0 auto;
            background: #fff;
            border-radius: 24px;
            padding: 25px 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .header {
            text-align: center;
            margin-bottom: 25px;
        }

        .header .icon { font-size: 50px; }
        .header h1 { font-size: 22px; color: #1a1a2e; margin: 10px 0 5px; }
        .header p { color: #666; font-size: 14px; }

        /* Big green button */
        .main-btn {
            display: block;
            width: 100%;
            padding: 20px;
            font-size: 18px;
            font-weight: 700;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: #fff;
            border: none;
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .main-btn:active { transform: scale(0.98); }
        .main-btn:disabled { opacity: 0.6; }

        /* Steps */
        .steps { display: none; margin-top: 25px; }
        .steps.show { display: block; }

        .step {
            background: #f8fafc;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
        }

        .step-head {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .step-num {
            width: 32px;
            height: 32px;
            background: #667eea;
            color: #fff;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 14px;
        }

        .step-title { font-size: 16px; font-weight: 700; color: #1a1a2e; }

        .step-btn {
            display: block;
            width: 100%;
            padding: 16px;
            font-size: 16px;
            font-weight: 600;
            background: #667eea;
            color: #fff;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            text-decoration: none;
            text-align: center;
        }

        .step-btn:active { opacity: 0.9; }

        .step-hint {
            margin-top: 10px;
            padding: 12px;
            background: #fef3c7;
            border-radius: 10px;
            color: #92400e;
            font-size: 13px;
            line-height: 1.5;
        }

        /* QR */
        .qr-box {
            background: #fff;
            border: 3px solid #10b981;
            border-radius: 16px;
            padding: 15px;
            text-align: center;
        }

        .qr-box canvas { max-width: 100%; }
        
        .qr-label {
            margin-top: 10px;
            font-size: 13px;
            color: #666;
        }

        /* Final */
        .final {
            background: #dcfce7;
            border-radius: 16px;
            padding: 20px;
            text-align: center;
            margin-top: 15px;
        }

        .final .icon { font-size: 40px; }
        .final h3 { color: #166534; margin: 10px 0 5px; }
        .final p { color: #15803d; font-size: 14px; }

        .error {
            margin-top: 15px;
            padding: 15px;
            background: #fee2e2;
            border-radius: 12px;
            color: #dc2626;
            font-size: 14px;
            display: none;
        }
        .error.show { display: block; }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: #1a1a2e;
            color: #fff;
            padding: 15px 25px;
            border-radius: 12px;
            font-size: 14px;
            opacity: 0;
            transition: all 0.3s;
        }
        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }

        /* FAQ Styles */
        .faq-item {
            margin-bottom: 12px;
            background: rgba(30, 41, 59, 0.6);
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid rgba(71, 85, 105, 0.3);
            transition: all 0.3s;
        }
        .faq-item:hover {
            border-color: rgba(102, 126, 234, 0.5);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }
        .faq-question {
            padding: 16px 20px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: #fff;
            font-weight: 600;
            font-size: 15px;
            user-select: none;
        }
        .faq-question:hover {
            background: rgba(102, 126, 234, 0.1);
        }
        .faq-arrow {
            transition: transform 0.3s;
            font-size: 12px;
            color: #94a3b8;
        }
        .faq-item.active .faq-arrow {
            transform: rotate(180deg);
        }
        .faq-answer {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out, padding 0.3s;
            padding: 0 20px;
            color: #cbd5e1;
            font-size: 14px;
            line-height: 1.6;
        }
        .faq-item.active .faq-answer {
            max-height: 500px;
            padding: 0 20px 16px 20px;
        }
        .loading-dots {
            animation: pulse 1.5s ease-in-out infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body>
    <div class="card">
        <!-- Initial -->
        <div id="initial">
            <div class="header">
                <div class="icon">üì±</div>
                <h1>VPN –¥–ª—è Instagram –∏ YouTube</h1>
                <p>–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π —Ç–µ—Å—Ç –Ω–∞ 1 –¥–µ–Ω—å</p>
            </div>
            <button class="main-btn" id="startBtn" onclick="start()">
                üöÄ –ü–æ–ª—É—á–∏—Ç—å VPN –±–µ—Å–ø–ª–∞—Ç–Ω–æ
            </button>
            <div id="error" class="error"></div>
        </div>

        <!-- Steps -->
        <div id="steps" class="steps">
            
            <!-- Step 1: Download app -->
            <div class="step">
                <div class="step-head">
                    <div class="step-num">1</div>
                    <div class="step-title">–°–∫–∞—á–∞–π –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</div>
                </div>
                <a id="appLink" href="#" target="_blank" class="step-btn">
                    üì≤ –°–∫–∞—á–∞—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
                </a>
                <div class="step-hint">
                    üëÜ –ù–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É ‚Äî –æ—Ç–∫—Ä–æ–µ—Ç—Å—è –º–∞–≥–∞–∑–∏–Ω –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π. –£—Å—Ç–∞–Ω–æ–≤–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.
                </div>
            </div>

            <!-- Step 2: Scan QR -->
            <div class="step">
                <div class="step-head">
                    <div class="step-num">2</div>
                    <div class="step-title">–î–æ–±–∞–≤—å VPN –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</div>
                </div>
                <div class="qr-box">
                    <div id="qr"></div>
                    <div class="qr-label">QR-–∫–æ–¥ –¥–ª—è —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</div>
                </div>
                <div class="step-hint" id="scanHint">
                    üì∏ –û—Ç–∫—Ä–æ–π –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ ‚Üí –Ω–∞–∂–º–∏ <b>+</b> ‚Üí –≤—ã–±–µ—Ä–∏ <b>"–°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å QR"</b> ‚Üí –Ω–∞–≤–µ–¥–∏ –∫–∞–º–µ—Ä—É –Ω–∞ —ç—Ç–æ—Ç –∫–æ–¥
                </div>
                
                <!-- Download buttons -->
                <div style="margin-top: 20px; display: flex; gap: 10px; flex-wrap: wrap; justify-content: center;">
                    <button onclick="downloadConfig()" style="padding: 12px 24px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #fff; border: none; border-radius: 12px; font-size: 15px; font-weight: 600; cursor: pointer; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4); transition: all 0.3s;">
                        üíæ –°–∫–∞—á–∞—Ç—å –∫–æ–Ω—Ñ–∏–≥ (JSON)
                    </button>
                    <button onclick="copyLink()" style="padding: 12px 24px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: #fff; border: none; border-radius: 12px; font-size: 15px; font-weight: 600; cursor: pointer; box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4); transition: all 0.3s;">
                        üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É
                    </button>
                </div>
                <div style="margin-top: 10px; text-align: center; font-size: 13px; color: #94a3b8;">
                    <b>–î–ª—è –∫–æ–º–ø—å—é—Ç–µ—Ä–∞:</b> –°–∫–∞—á–∞–π JSON –∫–æ–Ω—Ñ–∏–≥ –∏ –∏–º–ø–æ—Ä—Ç–∏—Ä—É–π –≤ v2rayN
                </div>
            </div>

            <!-- Step 3: Turn on -->
            <div class="step">
                <div class="step-head">
                    <div class="step-num">3</div>
                    <div class="step-title">–í–∫–ª—é—á–∏ VPN</div>
                </div>
                <div class="step-hint" id="turnOnHint">
                    ‚ñ∂Ô∏è –í –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –Ω–∞–∂–º–∏ –±–æ–ª—å—à—É—é –∫–Ω–æ–ø–∫—É <b>–≤–Ω–∏–∑—É —ç–∫—Ä–∞–Ω–∞</b> (–∏–ª–∏ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å). –ï—Å–ª–∏ —Ç–µ–ª–µ—Ñ–æ–Ω —Å–ø—Ä–æ—Å–∏—Ç —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ ‚Äî –Ω–∞–∂–º–∏ <b>"–û–ö"</b>.
                </div>
            </div>

            <!-- Done -->
            <div class="final">
                <div class="icon">üéâ</div>
                <h3>–ì–æ—Ç–æ–≤–æ!</h3>
                <p>–¢–µ–ø–µ—Ä—å –æ—Ç–∫—Ä–æ–π Instagram –∏–ª–∏ YouTube ‚Äî –≤—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç!</p>
            </div>
        </div>
    </div>

    <div id="toast" class="toast">‚úì –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!</div>

    <script>
        let vlessUri = '';
        let configToken = '';


        // Detect device
        function getDevice() {
            const ua = navigator.userAgent;
            if (/android/i.test(ua)) return 'android';
            if (/iphone|ipad|ipod/i.test(ua)) return 'ios';
            return 'desktop';
        }

        async function start() {
            const btn = document.getElementById('startBtn');
            const error = document.getElementById('error');
            
            btn.disabled = true;
            btn.textContent = '‚è≥ –ü–æ–¥–æ–∂–¥–∏—Ç–µ...';
            error.classList.remove('show');

            try {
                // Create user
                const res = await fetch('/api/create-user', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        email: `user_${Date.now()}@vpn.local`, 
                        planDuration: 1 
                    })
                });
                const data = await res.json();
                if (!data.success) throw new Error(data.error || '–û—à–∏–±–∫–∞');

                // Save config token for download
                configToken = data.data.configToken;

                // Get link
                const linkRes = await fetch(`/api/link/${configToken}`);
                const linkData = await linkRes.json();
                if (!linkData.success) throw new Error(linkData.error || '–û—à–∏–±–∫–∞');

                vlessUri = linkData.vlessUri;


                // Set app link based on device
                const device = getDevice();
                const appLink = document.getElementById('appLink');
                const scanHint = document.getElementById('scanHint');
                const turnOnHint = document.getElementById('turnOnHint');

                if (device === 'android') {
                    appLink.href = 'https://play.google.com/store/apps/details?id=com.v2ray.ang';
                    appLink.textContent = 'üì≤ –°–∫–∞—á–∞—Ç—å v2rayNG (Android)';
                    scanHint.innerHTML = 'üì∏ –û—Ç–∫—Ä–æ–π v2rayNG ‚Üí –Ω–∞–∂–º–∏ <b>+</b> –≤–≤–µ—Ä—Ö—É ‚Üí –≤—ã–±–µ—Ä–∏ <b>"–°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å QR-–∫–æ–¥"</b> ‚Üí –Ω–∞–≤–µ–¥–∏ –∫–∞–º–µ—Ä—É —Å—é–¥–∞';
                    turnOnHint.innerHTML = '‚ñ∂Ô∏è –ù–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É <b>V</b> –≤–Ω–∏–∑—É —ç–∫—Ä–∞–Ω–∞. –ï—Å–ª–∏ —Å–ø—Ä–æ—Å–∏—Ç —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ ‚Äî –Ω–∞–∂–º–∏ <b>"–û–ö"</b>.';
                } else if (device === 'ios') {
                    appLink.href = 'https://apps.apple.com/app/napsternetv/id1629465476';
                    appLink.textContent = 'üì≤ –°–∫–∞—á–∞—Ç—å NapsternetV (iPhone)';
                    scanHint.innerHTML = 'üì∏ –û—Ç–∫—Ä–æ–π NapsternetV ‚Üí –Ω–∞–∂–º–∏ <b>+</b> ‚Üí –≤—ã–±–µ—Ä–∏ <b>"Scan QR"</b> ‚Üí –Ω–∞–≤–µ–¥–∏ –∫–∞–º–µ—Ä—É —Å—é–¥–∞';
                    turnOnHint.innerHTML = '‚ñ∂Ô∏è –í–∫–ª—é—á–∏ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å VPN. –ï—Å–ª–∏ —Å–ø—Ä–æ—Å–∏—Ç —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ ‚Äî –Ω–∞–∂–º–∏ <b>"Allow"</b>.';
                } else {
                    appLink.href = 'https://github.com/2dust/v2rayN/releases/latest/download/v2rayN-With-Core.zip';
                    appLink.textContent = 'üíª –°–∫–∞—á–∞—Ç—å v2rayN (Windows)';
                    scanHint.innerHTML = 'üìã <b>–î–ª—è –∫–æ–º–ø—å—é—Ç–µ—Ä–∞:</b> <button onclick="copyLink()" style="padding:10px 20px;background:#10b981;color:#fff;border:none;border-radius:8px;font-size:14px;cursor:pointer;margin-top:10px;">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É</button><br><br>–í v2rayN: <b>–°–µ—Ä–≤–µ—Ä—ã</b> ‚Üí <b>–ò–º–ø–æ—Ä—Ç –∏–∑ –±—É—Ñ–µ—Ä–∞</b>';
                    turnOnHint.innerHTML = '‚ñ∂Ô∏è –ö–ª–∏–∫–Ω–∏ –ø—Ä–∞–≤–æ–π –∫–Ω–æ–ø–∫–æ–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä ‚Üí <b>"–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å"</b>. –ü–æ—Ç–æ–º: <b>–°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–∫—Å–∏ ‚Üí –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</b>.';
                }

                // Generate QR
                const qrContainer = document.getElementById('qr');
                qrContainer.innerHTML = ''; // Clear previous
                new QRCode(qrContainer, {
                    text: vlessUri,
                    width: 200,
                    height: 200,
                    colorDark: '#000000',
                    colorLight: '#ffffff',
                    correctLevel: QRCode.CorrectLevel.M
                });

                // Show steps
                document.getElementById('initial').style.display = 'none';
                document.getElementById('steps').classList.add('show');

            } catch (err) {
                error.textContent = '‚ùå ' + err.message;
                error.classList.add('show');
                btn.disabled = false;
                btn.textContent = 'üöÄ –ü–æ–ª—É—á–∏—Ç—å VPN –±–µ—Å–ø–ª–∞—Ç–Ω–æ';
            }
        }

        function copyLink() {
            navigator.clipboard.writeText(vlessUri).then(() => {
                const toast = document.getElementById('toast');
                toast.classList.add('show');
                setTimeout(() => toast.classList.remove('show'), 2000);
            });
        }

        async function downloadConfig() {
            if (!configToken) {
                alert('‚ùå –°–Ω–∞—á–∞–ª–∞ –Ω–∞–∂–º–∏—Ç–µ "–ü–æ–ª—É—á–∏—Ç—å VPN –±–µ—Å–ø–ª–∞—Ç–Ω–æ"');
                return;
            }

            try {
                // Fetch JSON config
                const res = await fetch(`/api/config/${configToken}`);
                if (!res.ok) throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥');
                
                const config = await res.json();
                
                // Create download
                const blob = new Blob([JSON.stringify(config, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'vpn_config.json';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                // Show success toast
                const toast = document.getElementById('toast');
                toast.textContent = '‚úÖ –ö–æ–Ω—Ñ–∏–≥ —Å–∫–∞—á–∞–Ω!';
                toast.classList.add('show');
                setTimeout(() => {
                    toast.textContent = '‚úì –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!'; // Reset toast text
                    toast.classList.remove('show');
                }, 2000);
            } catch (err) {
                alert('‚ùå –û—à–∏–±–∫–∞: ' + err.message);
            }
        }

        // Toggle FAQ
        function toggleFAQ(element) {
            const faqItem = element.parentElement;
            const wasActive = faqItem.classList.contains('active');
            document.querySelectorAll('.faq-item').forEach(item => item.classList.remove('active'));
            if (!wasActive) faqItem.classList.add('active');
        }

        // Share VPN
        async function shareVPN() {
            const shareData = {
                title: '–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π VPN –¥–ª—è Instagram',
                text: '–ü–æ–ª—É—á–∏ –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ Instagram –∏ YouTube –Ω–∞ 1 –¥–µ–Ω—å! üöÄ',
                url: window.location.href
            };
            try {
                if (navigator.share) {
                    await navigator.share(shareData);
                } else {
                    await navigator.clipboard.writeText(window.location.href);
                }
                const toast = document.getElementById('toast');
                toast.textContent = '‚úÖ –°–ø–∞—Å–∏–±–æ!';
                toast.classList.add('show');
                setTimeout(() => { toast.textContent = '‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!'; toast.classList.remove('show'); }, 2000);
            } catch (err) { console.error('Share failed:', err); }
        }

        // Load user count
        function loadUserCount() {
            setTimeout(() => {
                const count = Math.floor(Math.random() * 1500) + 1500;
                const el = document.getElementById('userCount');
                if (!el) return;
                let current = 0;
                const increment = count / 50;
                const timer = setInterval(() => {
                    current += increment;
                    if (current >= count) { el.textContent = count.toLocaleString('ru-RU'); clearInterval(timer); }
                    else { el.textContent = Math.floor(current).toLocaleString('ru-RU'); }
                }, 20);
            }, 500);
        }
        window.addEventListener('load', loadUserCount);
    </script>
</body>
</html>
