# üîß P0 FIXES ‚Äî –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø

**–î–∞—Ç–∞:** 18 –¥–µ–∫–∞–±—Ä—è 2025  
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô  
**–ó–∞—Ç—Ä–∞—Ç—ã –≤—Ä–µ–º–µ–Ω–∏:** 2-3 —á–∞—Å–∞

---

## FIX #1: Rate Limiting ‚Üí Vercel KV

### –§–∞–π–ª: `api/create-user/index.ts`

**–ë—ã–ª–æ (—Å—Ç—Ä–æ–∫–∞ 5):**

```typescript
import { checkRateLimit, RateLimitPresets } from "../../utils/rate-limit";
```

**–°—Ç–∞–ª–æ:**

```typescript
import { RateLimitStorage, RateLimitConfig } from "../../utils/storage";

// Presets –¥–ª—è KV-based rate limiting
const KV_RATE_PRESETS = {
  USER_CREATE: { maxRequests: 10, windowMs: 60000 },
};
```

**–ë—ã–ª–æ (—Å—Ç—Ä–æ–∫–∏ 37-44):**

```typescript
const rateLimitResult = checkRateLimit(req, RateLimitPresets.USER_CREATE);
if (!rateLimitResult.allowed) {
  return res.status(429).json({
    error: "–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —á–µ—Ä–µ–∑ –º–∏–Ω—É—Ç—É.",
    code: "RATE_LIMIT_EXCEEDED",
    retryAfter: rateLimitResult.retryAfter,
  });
}
```

**–°—Ç–∞–ª–æ:**

```typescript
// Get client IP for rate limiting
const forwardedFor = req.headers["x-forwarded-for"];
const clientIP =
  typeof forwardedFor === "string"
    ? forwardedFor.split(",")[0].trim()
    : "unknown";

const rateLimitResult = await RateLimitStorage.check(
  clientIP,
  KV_RATE_PRESETS.USER_CREATE
);
if (!rateLimitResult.allowed) {
  return res.status(429).json({
    error: "–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —á–µ—Ä–µ–∑ –º–∏–Ω—É—Ç—É.",
    code: "RATE_LIMIT_EXCEEDED",
    retryAfter: rateLimitResult.retryAfter,
  });
}
```

---

## FIX #2: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ telegramId –≤ payment metadata

### –§–∞–π–ª: `api/payment/create.ts`

**–ë—ã–ª–æ (—Å—Ç—Ä–æ–∫–∞ 41):**

```typescript
const {
  amount = 299,
  description = "VPN –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ 30 –¥–Ω–µ–π",
  email,
} = req.body || {};
```

**–°—Ç–∞–ª–æ:**

```typescript
const { amount = 99, planDuration = 30, telegramId, email } = req.body || {};

const description = `VPN –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ ${planDuration} –¥–Ω–µ–π`;
```

**–ë—ã–ª–æ (—Å—Ç—Ä–æ–∫–∏ 71-73):**

```typescript
metadata: {
  email: email || "anonymous";
}
```

**–°—Ç–∞–ª–æ:**

```typescript
metadata: {
  email: email || 'anonymous',
  telegramId: telegramId || undefined,
  planDuration: planDuration
}
```

---

## FIX #3: –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π base URL –≤ bot/webhook.ts

### –§–∞–π–ª: `api/bot/webhook.ts`

**–ë—ã–ª–æ (—Å—Ç—Ä–æ–∫–∏ 101-103):**

```typescript
async function sendVPNLink(botToken: string, chatId: number, userId: number, firstName: string) {
  const vpnUrl = `https://botinstasgram.vercel.app?tg_id=${userId}`;
  const payUrl = `https://botinstasgram.vercel.app?tg_id=${userId}&action=pay`;
```

**–°—Ç–∞–ª–æ:**

```typescript
async function sendVPNLink(botToken: string, chatId: number, userId: number, firstName: string) {
  // –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π base URL
  const baseUrl = process.env.VERCEL_URL
    ? `https://${process.env.VERCEL_URL}`
    : process.env.BASE_URL || 'https://botinstasgram.vercel.app';

  const vpnUrl = `${baseUrl}?tg_id=${userId}`;
  const payUrl = `${baseUrl}?tg_id=${userId}&action=pay`;
```

---

## FIX #4: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ Trial –≤ KV Storage

### –§–∞–π–ª: `api/create-user/index.ts`

**–î–æ–±–∞–≤–∏—Ç—å –∏–º–ø–æ—Ä—Ç:**

```typescript
import { TrialStorage } from "../../utils/storage";
```

**–ü–æ—Å–ª–µ —Å—Ç—Ä–æ–∫–∏ 145 (–ø–æ—Å–ª–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ configToken) –¥–æ–±–∞–≤–∏—Ç—å:**

```typescript
// ‚úÖ –°–æ—Ö—Ä–∞–Ω—è–µ–º trial –≤ KV –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è
if (isTrial && telegramId) {
  await TrialStorage.markUsed(telegramId, {
    telegramId,
    email,
    uuid,
    createdAt: new Date().toISOString(),
    expiresAt,
    used: true,
  });
}
```

---

## ‚ö° QUICK APPLY SCRIPT

–î–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –≤—Å–µ—Ö –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π –º–æ–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å —Å–∫—Ä–∏–ø—Ç:

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–µ–∫—É—â—É—é –≤–µ—Ç–∫—É
git status

# –°–æ–∑–¥–∞—Ç—å feature branch
git checkout -b fix/p0-critical-issues

# –ü—Ä–∏–º–µ–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è (–≤—Ä—É—á–Ω—É—é –∏–ª–∏ —á–µ—Ä–µ–∑ claude)

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–±–æ—Ä–∫—É
npm run build

# –î–µ–ø–ª–æ–π –Ω–∞ preview
vercel

# –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ preview...

# Merge –≤ main
git checkout main
git merge fix/p0-critical-issues
git push origin main
```

---

## ‚úÖ CHECKLIST –ü–û–°–õ–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ô

- [ ] Rate limiting –∏—Å–ø–æ–ª—å–∑—É–µ—Ç Vercel KV
- [ ] telegramId —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ payment metadata
- [ ] Bot –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π base URL
- [ ] Trial —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ TrialStorage
- [ ] `npm run build` –ø—Ä–æ—Ö–æ–¥–∏—Ç –±–µ–∑ –æ—à–∏–±–æ–∫
- [ ] Health check –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç storage: "vercel-kv"
- [ ] Test payment —Å–æ–∑–¥–∞—ë—Ç –∑–∞–ø–∏—Å—å —Å telegramId
