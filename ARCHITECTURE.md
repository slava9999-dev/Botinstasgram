# ğŸ—ï¸ ĞĞ Ğ¥Ğ˜Ğ¢Ğ•ĞšĞ¢Ğ£Ğ Ğ ĞŸĞ ĞĞ•ĞšĞ¢Ğ VPN CONNECT

**Ğ’ĞµÑ€ÑĞ¸Ñ:** 2.1.0  
**Ğ”Ğ°Ñ‚Ğ°:** 16 Ğ´ĞµĞºĞ°Ğ±Ñ€Ñ 2025  
**Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ:** Production Ready (85%)

---

## ğŸ“ ĞĞ‘Ğ©ĞĞ¯ ĞĞ Ğ¥Ğ˜Ğ¢Ğ•ĞšĞ¢Ğ£Ğ Ğ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    VERCEL SERVERLESS                         â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚   Frontend   â”‚  â”‚   API Layer  â”‚  â”‚   Utilities  â”‚      â”‚
â”‚  â”‚              â”‚  â”‚              â”‚  â”‚              â”‚      â”‚
â”‚  â”‚ - index.html â”‚  â”‚ - payment/*  â”‚  â”‚ - panel.ts   â”‚      â”‚
â”‚  â”‚ - test.html  â”‚  â”‚ - config/*   â”‚  â”‚ - jwt.ts     â”‚      â”‚
â”‚  â”‚ - success.   â”‚  â”‚ - users/*    â”‚  â”‚ - logger.ts  â”‚      â”‚
â”‚  â”‚   html       â”‚  â”‚ - health     â”‚  â”‚ - rate-limit â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                           â”‚                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚               â”‚               â”‚
            â–¼               â–¼               â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Ğ®Kassa API  â”‚ â”‚  3X-UI Panel â”‚ â”‚   Client     â”‚
    â”‚              â”‚ â”‚              â”‚ â”‚  (v2rayN/NG) â”‚
    â”‚ - Payments   â”‚ â”‚ - Users      â”‚ â”‚              â”‚
    â”‚ - Webhooks   â”‚ â”‚ - Configs    â”‚ â”‚ - Connects   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ—‚ï¸ Ğ¡Ğ¢Ğ Ğ£ĞšĞ¢Ğ£Ğ Ğ Ğ¤ĞĞ™Ğ›ĞĞ’

### **ĞšĞ¾Ñ€Ğ½ĞµĞ²Ğ°Ñ ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ°:**

```
BotiNstsgram/
â”œâ”€â”€ api/                      # Serverless API endpoints
â”‚   â”œâ”€â”€ config/
â”‚   â”‚   â””â”€â”€ [token].ts       # GET /api/config/:token
â”‚   â”œâ”€â”€ create-user/
â”‚   â”‚   â””â”€â”€ index.ts         # POST /api/create-user
â”‚   â”œâ”€â”€ health/
â”‚   â”‚   â””â”€â”€ index.ts         # GET /api/health
â”‚   â”œâ”€â”€ link/
â”‚   â”‚   â””â”€â”€ [token].ts       # GET /api/link/:token
â”‚   â”œâ”€â”€ payment/
â”‚   â”‚   â”œâ”€â”€ create.ts        # POST /api/payment/create
â”‚   â”‚   â”œâ”€â”€ status.ts        # GET /api/payment/status
â”‚   â”‚   â””â”€â”€ webhook.ts       # POST /api/payment/webhook
â”‚   â””â”€â”€ users/
â”‚       â””â”€â”€ [uuid]/
â”‚           â””â”€â”€ traffic.ts   # GET /api/users/:uuid/traffic
â”‚
â”œâ”€â”€ public/                   # Static frontend files
â”‚   â”œâ”€â”€ index.html           # Landing page
â”‚   â”œâ”€â”€ test.html            # Free test page
â”‚   â”œâ”€â”€ success.html         # Payment success page
â”‚   â”œâ”€â”€ offer.html           # Terms of service
â”‚   â”œâ”€â”€ privacy.html         # Privacy policy
â”‚   â””â”€â”€ *.png                # Images
â”‚
â”œâ”€â”€ utils/                    # Shared utilities
â”‚   â”œâ”€â”€ jwt.ts               # JWT token management
â”‚   â”œâ”€â”€ logger.ts            # Structured logging
â”‚   â”œâ”€â”€ panel.ts             # 3X-UI API client
â”‚   â”œâ”€â”€ payment-helpers.ts   # Payment utilities
â”‚   â”œâ”€â”€ rate-limit.ts        # Rate limiting
â”‚   â””â”€â”€ routing.json         # Xray routing rules
â”‚
â”œâ”€â”€ .env.example             # Environment variables template
â”œâ”€â”€ .gitignore               # Git ignore rules
â”œâ”€â”€ package.json             # Dependencies (LOCKED VERSIONS)
â”œâ”€â”€ tsconfig.json            # TypeScript configuration
â”œâ”€â”€ vercel.json              # Vercel deployment config
â”œâ”€â”€ README.md                # Main documentation
â”œâ”€â”€ TODO.md                  # Project status
â”œâ”€â”€ SPEC.md                  # Technical specification
â””â”€â”€ ARCHITECTURE.md          # This file
```

---

## ğŸ”„ ĞŸĞĞ¢ĞĞš Ğ”ĞĞĞĞ«Ğ¥

### **1. ĞŸĞ»Ğ°Ñ‚Ñ‘Ğ¶Ğ½Ñ‹Ğ¹ Ğ¿Ğ¾Ñ‚Ğ¾Ğº:**

```
User â†’ index.html â†’ POST /api/payment/create â†’ Ğ®Kassa
                                                    â”‚
                                                    â–¼
User â† success.html â† POST /api/payment/webhook â† Ğ®Kassa
         â”‚
         â–¼
    GET /api/payment/status (polling)
         â”‚
         â–¼
    GET /api/config/:token (download config)
```

### **2. Ğ‘ĞµÑĞ¿Ğ»Ğ°Ñ‚Ğ½Ñ‹Ğ¹ Ñ‚ĞµÑÑ‚:**

```
User â†’ test.html â†’ POST /api/create-user â†’ 3X-UI Panel
                                               â”‚
                                               â–¼
User â† QR Code â† GET /api/link/:token â† JWT Token
```

### **3. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ñ‚Ñ€Ğ°Ñ„Ğ¸ĞºĞ°:**

```
User â†’ GET /api/users/:uuid/traffic â†’ 3X-UI Panel â†’ Traffic Stats
```

---

## ğŸ” Ğ‘Ğ•Ğ—ĞĞŸĞĞ¡ĞĞĞ¡Ğ¢Ğ¬

### **Ğ£Ñ€Ğ¾Ğ²Ğ½Ğ¸ Ğ·Ğ°Ñ‰Ğ¸Ñ‚Ñ‹:**

1. **Rate Limiting** (in-memory)

   - Payment create: 5 req/min
   - User create: 10 req/min
   - Config fetch: 30 req/min
   - Status check: 60 req/min

2. **JWT Tokens** (stateless)

   - HS256 algorithm
   - Expiration: 365 days
   - Embedded client info (no DB needed)

3. **CORS** (configured)

   - Allow-Origin: \*
   - Allow-Methods: GET, POST, OPTIONS
   - Allow-Headers: Content-Type, Authorization

4. **Input Validation**

   - Email format check
   - Plan duration: 1-365 days
   - Amount: 1-100000 rubles
   - UUID format validation

5. **Environment Variables**
   - Validation on startup
   - Fail-fast if missing critical vars

---

## ğŸ“Š ĞœĞĞĞ˜Ğ¢ĞĞ Ğ˜ĞĞ“

### **Ğ›Ğ¾Ğ³Ğ¸Ñ€ÑƒĞµĞ¼Ñ‹Ğµ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ:**

```typescript
// User events
-user_created -
  user_creation_failed -
  // Config events
  config_generated -
  config_generation_failed -
  // Panel events
  panel_login_success -
  panel_login_failed -
  panel_api_error -
  // Token events
  token_generated -
  token_expired -
  token_invalid -
  // Payment events
  payment_created -
  payment_succeeded -
  payment_failed -
  webhook_received -
  webhook_ignored -
  // Security events
  rate_limit_exceeded -
  // Traffic events
  traffic_checked;
```

### **Health Check:**

```bash
GET /api/health

Response:
{
  "timestamp": "2025-12-16T11:00:00.000Z",
  "status": "healthy" | "degraded" | "unhealthy",
  "services": {
    "jwt": { "status": "ok" },
    "yookassa": { "status": "ok" },
    "panel": { "status": "ok" },
    "reality": { "status": "ok" }
  }
}
```

---

## ğŸ”§ Ğ¢Ğ•Ğ¥ĞĞĞ›ĞĞ“Ğ˜Ğ§Ğ•Ğ¡ĞšĞ˜Ğ™ Ğ¡Ğ¢Ğ•Ğš

| ĞšĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚       | Ğ¢ĞµÑ…Ğ½Ğ¾Ğ»Ğ¾Ğ³Ğ¸Ñ        | Ğ’ĞµÑ€ÑĞ¸Ñ | ĞŸÑ€Ğ¸Ñ‡Ğ¸Ğ½Ğ° Ğ²Ñ‹Ğ±Ğ¾Ñ€Ğ°               |
| --------------- | ----------------- | ------ | ---------------------------- |
| **Runtime**     | Node.js           | 18+    | Vercel requirement           |
| **Framework**   | Vercel Serverless | -      | Zero config, auto-scaling    |
| **Language**    | TypeScript        | 5.3.3  | Type safety                  |
| **HTTP Client** | Axios             | 1.6.7  | Reliable, well-tested        |
| **Auth**        | JWT               | 9.0.2  | Stateless, scalable          |
| **Payment**     | Ğ®Kassa API        | v3     | Russian market leader        |
| **VPN Panel**   | 3X-UI             | Latest | Open source, Reality support |
| **Protocol**    | VLESS Reality     | -      | Modern, unblockable          |

---

## ğŸš€ DEPLOYMENT

### **Vercel Configuration:**

```json
{
  "rewrites": [
    { "source": "/api/config/:token", "destination": "/api/config/[token]" },
    { "source": "/api/link/:token", "destination": "/api/link/[token]" }
  ],
  "functions": {
    "api/payment/webhook.ts": { "maxDuration": 30 },
    "api/create-user/index.ts": { "maxDuration": 30 }
  }
}
```

### **Environment Variables (Required):**

```bash
# Critical (must have)
JWT_SECRET=xxx
PANEL_URL=https://xxx:2053
PANEL_USER=admin
PANEL_PASS=xxx
INBOUND_ID=1

# Payment (for production)
YOOKASSA_SHOP_ID=123456
YOOKASSA_SECRET_KEY=live_xxx

# Reality (from 3X-UI)
REALITY_PK=xxx
REALITY_SHORT_ID=xxx
SNI_DOMAIN=yahoo.com
```

---

## ğŸ“ˆ ĞœĞĞ¡Ğ¨Ğ¢ĞĞ‘Ğ˜Ğ ĞĞ’ĞĞĞ˜Ğ•

### **Ğ¢ĞµĞºÑƒÑ‰Ğ¸Ğµ Ğ¾Ğ³Ñ€Ğ°Ğ½Ğ¸Ñ‡ĞµĞ½Ğ¸Ñ:**

1. **In-memory storage:**

   - Rate limiting: ÑĞ±Ñ€Ğ°ÑÑ‹Ğ²Ğ°ĞµÑ‚ÑÑ Ğ¿Ñ€Ğ¸ cold start
   - Payment records: Ñ‚ĞµÑ€ÑÑÑ‚ÑÑ Ğ¿Ñ€Ğ¸ Ñ€ĞµÑÑ‚Ğ°Ñ€Ñ‚Ğµ
   - **Ğ ĞµÑˆĞµĞ½Ğ¸Ğµ:** Migr migrate to Vercel KV

2. **Single region:**

   - Vercel auto-deploys globally
   - But 3X-UI panel is single-server
   - **Ğ ĞµÑˆĞµĞ½Ğ¸Ğµ:** Multi-region 3X-UI setup

3. **No database:**
   - Stateless JWT (good!)
   - But no user management
   - **Ğ ĞµÑˆĞµĞ½Ğ¸Ğµ:** Add PostgreSQL for analytics

### **Roadmap Ğ´Ğ»Ñ Ğ¼Ğ°ÑÑˆÑ‚Ğ°Ğ±Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ:**

**Phase 1: Persistent Storage**

- [ ] Vercel KV for rate limiting
- [ ] Vercel KV for payment records
- [ ] PostgreSQL for user analytics

**Phase 2: Multi-region**

- [ ] Multiple 3X-UI servers
- [ ] Geo-routing based on user location
- [ ] Load balancing

**Phase 3: Advanced Features**

- [ ] Admin dashboard
- [ ] Real-time analytics
- [ ] Auto-renewal subscriptions
- [ ] Referral system

---

## ğŸ” ĞšĞ Ğ˜Ğ¢Ğ˜Ğ§Ğ•Ğ¡ĞšĞ˜Ğ• Ğ¢ĞĞ§ĞšĞ˜

### **Ğ§Ñ‚Ğ¾ Ğ¼Ğ¾Ğ¶ĞµÑ‚ ÑĞ»Ğ¾Ğ¼Ğ°Ñ‚ÑŒÑÑ:**

1. **3X-UI Panel Ğ½ĞµĞ´Ğ¾ÑÑ‚ÑƒĞ¿ĞµĞ½**

   - Impact: ĞĞµ ÑĞ¾Ğ·Ğ´Ğ°ÑÑ‚ÑÑ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ğ¸
   - Mitigation: Health check + retry logic
   - Monitoring: panel_api_error events

2. **JWT_SECRET Ğ¸Ğ·Ğ¼ĞµĞ½Ğ¸Ğ»ÑÑ**

   - Impact: Ğ’ÑĞµ Ñ‚Ğ¾ĞºĞµĞ½Ñ‹ Ğ½ĞµĞ²Ğ°Ğ»Ğ¸Ğ´Ğ½Ñ‹
   - Mitigation: ĞĞ˜ĞšĞĞ“Ğ”Ğ ĞĞ• ĞœĞ•ĞĞ¯Ğ¢Ğ¬ Ğ² Ğ¿Ñ€Ğ¾Ğ´Ğ°ĞºÑˆĞµĞ½Ğµ
   - Monitoring: token_invalid events

3. **Ğ®Kassa webhook Ğ½Ğµ Ğ´Ğ¾Ñ…Ğ¾Ğ´Ğ¸Ñ‚**

   - Impact: ĞŸĞ»Ğ°Ñ‚ĞµĞ¶Ğ¸ Ğ½Ğµ Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´Ğ°ÑÑ‚ÑÑ
   - Mitigation: Manual verification via status API
   - Monitoring: webhook_received events

4. **Rate limit in-memory ÑĞ±Ñ€Ğ¾ÑĞ¸Ğ»ÑÑ**
   - Impact: Ğ’Ğ¾Ğ·Ğ¼Ğ¾Ğ¶ĞµĞ½ ÑĞ¿Ğ°Ğ¼
   - Mitigation: Migrate to Vercel KV
   - Monitoring: rate_limit_exceeded events

---

## ğŸ§ª Ğ¢Ğ•Ğ¡Ğ¢Ğ˜Ğ ĞĞ’ĞĞĞ˜Ğ•

### **Ğ§ĞµĞº-Ğ»Ğ¸ÑÑ‚ Ğ¿ĞµÑ€ĞµĞ´ Ğ¿Ñ€Ğ¾Ğ´Ğ°ĞºÑˆĞµĞ½Ğ¾Ğ¼:**

- [ ] Health check Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ 200
- [ ] Ğ¢ĞµÑÑ‚Ğ¾Ğ²Ñ‹Ğ¹ Ğ¿Ğ»Ğ°Ñ‚Ñ‘Ğ¶ Ğ¿Ñ€Ğ¾Ñ…Ğ¾Ğ´Ğ¸Ñ‚
- [ ] Webhook Ğ²Ñ‹Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ÑÑ
- [ ] Config ÑĞºĞ°Ñ‡Ğ¸Ğ²Ğ°ĞµÑ‚ÑÑ
- [ ] VPN Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡Ğ°ĞµÑ‚ÑÑ
- [ ] Instagram/YouTube Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ÑÑ‚
- [ ] Rate limiting ÑÑ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°ĞµÑ‚
- [ ] Ğ›Ğ¾Ğ³Ğ¸ Ğ¿Ğ¸ÑˆÑƒÑ‚ÑÑ ĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ğ¾

### **Ğ¢ĞµÑÑ‚Ğ¾Ğ²Ñ‹Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ:**

```bash
# YooKassa test card
Card: 5555 5555 5555 4477
Expiry: 12/24
CVC: 123

# Test email
Email: test_user_${timestamp}@vpn.local

# Test UUID
UUID: Generated via uuidv4()
```

---

## ğŸ“ CHANGELOG

### **v2.1.0 (2025-12-16)**

- âœ… Added rate limiting
- âœ… Added structured logging
- âœ… Added health check endpoint
- âœ… Added traffic statistics endpoint
- âœ… Improved documentation
- âœ… Fixed package versions

### **v2.0.0 (2025-12-15)**

- âœ… Initial release
- âœ… YooKassa integration
- âœ… 3X-UI integration
- âœ… VLESS Reality support
- âœ… Responsive UI

---

## ğŸ”— Ğ¡Ğ¡Ğ«Ğ›ĞšĞ˜

- **Production:** https://botinstasgram.vercel.app/
- **GitHub:** https://github.com/slava9999-dev/Botinstasgram
- **Vercel:** https://vercel.com/dashboard
- **3X-UI:** https://github.com/mhsanaei/3x-ui
- **Ğ®Kassa:** https://yookassa.ru/developers

---

**Ğ”Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»Ñ‘Ğ½:** 16 Ğ´ĞµĞºĞ°Ğ±Ñ€Ñ 2025  
**ĞĞ²Ñ‚Ğ¾Ñ€:** NeuroExpert Architect  
**Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ:** âœ… Ğ—Ğ°Ñ†ĞµĞ¼ĞµĞ½Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¾
